{% extends "base.html" %}
{% load static %}

{% block title %}Finance Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<h1>Finance Dashboard</h1>

<style>
    /* Set a max width for all charts */
    .chart-container {
        width: 80%;
        max-width: 600px;
        /* Limit width to 600px */
        margin: 20px auto;
    }

    canvas {
        width: 100% !important;
        /* Ensure it scales inside container */
        height: 300px !important;
        /* Fixed height */
    }
</style>

<!-- Embed JSON data safely -->
{{ category_sales|json_script:"category-sales-data" }}
{{ store_stock_value|json_script:"store-stock-data" }}
{{ top_products|json_script:"top-products-data" }}

<!-- Total Sales by Category Chart -->
<div class="chart-container">
    <h2>Total Sales by Category</h2>
    <canvas id="categorySalesChart"></canvas>
</div>

<!-- Stock Value by Store Chart -->
<div class="chart-container">
    <h2>Stock Value by Store</h2>
    <canvas id="storeStockValueChart"></canvas>
</div>

<!-- Top-Selling Products Chart -->
<div class="chart-container">
    <h2>Top-Selling Products</h2>
    <canvas id="topProductsChart"></canvas>
</div>

<!-- Chart.js Script -->
<script>
    function parseJSONData(id) {
        const element = document.getElementById(id);
        return element ? JSON.parse(element.textContent) : [];
    }

    const categorySales = parseJSONData("category-sales-data");
    const storeStockValue = parseJSONData("store-stock-data");
    const topProducts = parseJSONData("top-products-data");

    const categorySalesChartCtx = document.getElementById("categorySalesChart").getContext("2d");
    new Chart(categorySalesChartCtx, {
        type: "bar",
        data: {
            labels: categorySales.map(item => item.category__name),
            datasets: [{
                label: "Total Sales",
                data: categorySales.map(item => item.total_sales),
                backgroundColor: "rgba(75, 192, 192, 0.5)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    const storeStockValueChartCtx = document.getElementById("storeStockValueChart").getContext("2d");
    new Chart(storeStockValueChartCtx, {
        type: "pie",
        data: {
            labels: storeStockValue.map(item => item.name),
            datasets: [{
                label: "Stock Value",
                data: storeStockValue.map(item => item.stock_value),
                backgroundColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff"],
                borderColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff"],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    const topProductsChartCtx = document.getElementById("topProductsChart").getContext("2d");
    new Chart(topProductsChartCtx, {
        type: "line",
        data: {
            labels: topProducts.map(item => item.name),
            datasets: [{
                label: "Total Value",
                data: topProducts.map(item => item.total_value),
                backgroundColor: "rgba(153, 102, 255, 0.5)",
                borderColor: "rgba(153, 102, 255, 1)",
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>

{% endblock %}